<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .actions {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .messages {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .message-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-meta {
            color: #999;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– WhatsApp Bot Dashboard</h1>
            <p>××¢×¨×›×ª × ×™×”×•×œ ×•××¢×§×‘ ××—×¨ ×”×•×“×¢×•×ª ×•×•×¦××¤ ×¢× × ×™×ª×•×— ×“×—×™×¤×•×ª ×‘×××¦×¢×•×ª AI</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">{{ stats.total_messages or 0 }}</div>
                <div class="stat-label">×¡×”"×› ×”×•×“×¢×•×ª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unansweredConversations">{{ stats.unanswered_conversations or 0 }}</div>
                <div class="stat-label">×©×™×—×•×ª ×¤×ª×•×—×•×ª</div>
            </div>
            <div class="stat-card" onclick="showUrgentConversations()" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-number" id="urgentConversations">{{ stats.urgent_conversations or 0 }}</div>
                <div class="stat-label">×©×™×—×•×ª ×“×—×•×¤×•×ª ğŸ‘ï¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeChats">{{ stats.active_chats or 0 }}</div>
                <div class="stat-label">×¦'××˜×™× ×¤×¢×™×œ×™×</div>
            </div>
        </div>
        
        <div class="actions">
            <h2>×¤×¢×•×œ×•×ª</h2>
            <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="globalExcludeGroups" onchange="toggleGlobalGroupFilter()" style="margin-left: 10px;">
                    <span>ğŸ›ï¸ ×¡× ×Ÿ ×›×œ ×”×•×“×¢×•×ª ××§×‘×•×¦×•×ª ××”×“×©×‘×•×¨×“</span>
                </label>
            </div>
            <button class="btn" onclick="analyzeMessages()">ğŸ” × ×ª×— ×”×•×“×¢×•×ª</button>
            <button class="btn" onclick="fetchRecentMessages()">ğŸ“¥ ××©×•×š ×”×•×“×¢×•×ª ××—×¨×•× ×•×ª</button>
            <button class="btn" onclick="refreshStatus()">ğŸ”„ ×¨×¢× ×Ÿ ×¡×˜×˜×•×¡</button>
            <button class="btn" onclick="showSendMessageModal()">ğŸ“¤ ×©×œ×— ×”×•×“×¢×”</button>
            <button class="btn" onclick="showDatabaseStats()">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¡×“ × ×ª×•× ×™×</button>
            <button class="btn" onclick="showConfigModal()">âš™ï¸ ×”×’×“×¨×•×ª</button>
        </div>
        
        <div id="configModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h2>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
                
                <div class="form-group">
                    <label for="greenApiUrl">Green API URL:</label>
                    <input type="text" id="greenApiUrl" value="{{ settings.green_api_url or 'https://api.green-api.com' }}">
                </div>
                
                <div class="form-group">
                    <label for="greenApiId">ID Instance:</label>
                    <input type="text" id="greenApiId" value="{{ settings.green_api_id_instance or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="greenApiToken">API Token Instance:</label>
                    <input type="password" id="greenApiToken" value="{{ settings.green_api_token_instance or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="userPhoneNumber">××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×“×•×—×•×ª (××œ× ×¢× ×§×™×“×•××ª):</label>
                    <input type="tel" id="userPhoneNumber" placeholder="9725012345678" value="{{ settings.user_phone_number or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="openrouterKey">OpenRouter API Key:</label>
                    <input type="password" id="openrouterKey" value="{{ settings.openrouter_api_key or '' }}">
                </div>
                
                <div style="margin-top: 20px; text-align: left;">
                    <button class="btn" onclick="saveConfig()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
                    <button class="btn" style="background: #6c757d;" onclick="closeConfigModal()">âŒ ×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
        
        <div id="fetchMessagesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;">
                <h2>ğŸ“¥ ××©×™×›×ª ×”×•×“×¢×•×ª ××—×¨×•× ×•×ª</h2>
                
                <div class="form-group">
                    <label for="messageMinutes">×˜×•×•×— ×–××Ÿ (×‘×“×§×•×ª):</label>
                    <select id="messageMinutes" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                        <option value="10">10 ×“×§×•×ª ××—×¨×•× ×•×ª</option>
                        <option value="30">30 ×“×§×•×ª ××—×¨×•× ×•×ª</option>
                        <option value="60">×©×¢×” ××—×¨×•× ×”</option>
                        <option value="180">3 ×©×¢×•×ª ××—×¨×•× ×•×ª</option>
                        <option value="360">6 ×©×¢×•×ª ××—×¨×•× ×•×ª</option>
                        <option value="1440">24 ×©×¢×•×ª ××—×¨×•× ×•×ª</option>
                        <option value="custom">××•×ª×× ××™×©×™×ª...</option>
                    </select>
                </div>
                
                <div class="form-group" id="customMinutesGroup" style="display: none;">
                    <label for="customMinutes">××¡×¤×¨ ×“×§×•×ª ××•×ª××:</label>
                    <input type="number" id="customMinutes" min="1" max="10080" placeholder="×”×›× ×¡ ××¡×¤×¨ ×“×§×•×ª (1-10080)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="useDatabase" checked> ×”×©×ª××© ×‘××¡×“ × ×ª×•× ×™× (××”×™×¨ ×™×•×ª×¨)
                    </label>
                    <div style="background: #fff3cd; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.9em;">
                        âš ï¸ <strong>×—×©×•×‘:</strong> ×‘×™×˜×•×œ ×”×¡×™××•×Ÿ ×™×©×œ×•×£ ×”×•×“×¢×•×ª ×™×©×™×¨×•×ª ×-Green API (××™×˜×™ ×•×™×›×•×œ ×œ×’×¨×•× ×œ-rate limit).
                        <br>××•××œ×¥ ×œ×”×©××™×¨ ××¡×•××Ÿ ×•×œ×”×©×ª××© ×‘-API ×¨×§ ×›×©×¦×¨×™×š ×”×•×“×¢×•×ª ×—×“×©×•×ª.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="excludeGroups" checked> ×¡× ×Ÿ ×”×•×“×¢×•×ª ××§×‘×•×¦×•×ª (×”×¦×’ ×¨×§ ×”×•×“×¢×•×ª ×¤×¨×˜×™×•×ª)
                    </label>
                </div>
                
                <div style="margin-top: 20px; text-align: left;">
                    <button class="btn" onclick="executeFetchMessages()">ğŸ“¥ ××©×•×š ×”×•×“×¢×•×ª</button>
                    <button class="btn" style="background: #6c757d;" onclick="closeFetchMessagesModal()">âŒ ×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
        
        <div class="messages">
            <h2>×”×•×“×¢×•×ª ××—×¨×•× ×•×ª</h2>
            <div id="messagesList">
                {% for message in recent_messages %}
                <div class="message-item">
                    <div class="message-content">
                        {% set is_group = message.chat_id and message.chat_id.endswith('@g.us') %}
                        {% set group_indicator = ' ğŸ›ï¸ (×§×‘×•×¦×”)' if is_group else ' ğŸ‘¤ (×¤×¨×˜×™×ª)' %}
                        <strong>{{ message.sender_name or message.sender_contact_name or '×œ× ×™×“×•×¢' }}{{ group_indicator }}</strong>
                        <p>{{ message.text_message or '(×”×•×“×¢×ª ××“×™×”)' }}</p>
                        <div class="message-meta">
                            {{ message.chat_id }} â€¢ 
                            {% set timestamp = message.timestamp %}
                            {{ (timestamp | int) | timestamp_to_datetime }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div id="notification" style="display: none;"></div>
        
    <div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center;">
            <h2>ğŸ”„ ×× ×ª×— ×”×•×“×¢×•×ª...</h2>
            <div style="margin: 20px 0;">
                <div style="width: 100%; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 20px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; border-radius: 10px;"></div>
                </div>
                <div id="progressText" style="margin-top: 10px; color: #666; font-weight: 500;">0%</div>
            </div>
            <div id="progressStatus" style="color: #333; margin-bottom: 20px;">××ª×—×™×œ × ×™×ª×•×—...</div>
            <div id="progressDetails" style="color: #666; font-size: 0.9em; text-align: right;"></div>
        </div>
    </div>
    
    <div id="urgentConversationsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸš¨ ×©×™×—×•×ª ×“×—×•×¤×•×ª</h2>
                <button onclick="closeUrgentConversationsModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">âœ• ×¡×’×•×¨</button>
            </div>
            <div id="urgentConversationsList" style="text-align: right;"></div>
        </div>
    </div>
    
    <script>
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = type;
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        function showProgressModal() {
            document.getElementById('progressModal').style.display = 'block';
        }
        
        function hideProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
        }
        
        function updateProgress(percentage, status, details = '') {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
            document.getElementById('progressStatus').textContent = status;
            if (details) {
                document.getElementById('progressDetails').textContent = details;
            }
        }
        
        let progressInterval;
        let analysisStartTime;
        
        async function analyzeMessages() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '×× ×ª×—...';
            
            // Show progress modal
            showProgressModal();
            analysisStartTime = Date.now();
            updateProgress(0, '××ª×—×™×œ × ×™×ª×•×—...', '××ª×—×‘×¨ ×œ-Green API');
            
            try {
                // Start progress simulation
                let progressStep = 0;
                progressInterval = setInterval(() => {
                    progressStep += 1;
                    const elapsed = Math.floor((Date.now() - analysisStartTime) / 1000);
                    
                    if (progressStep <= 20) {
                        updateProgress(progressStep, '××•×©×š ×”×•×“×¢×•×ª ××”-API...', `×–××Ÿ ×©×—×œ×•×£: ${elapsed} ×©× ×™×•×ª`);
                    } else if (progressStep <= 40) {
                        updateProgress(progressStep, '×××ª×¨ ×©×™×—×•×ª ×¤×ª×•×—×•×ª...', `×× ×ª×— ×”×•×“×¢×•×ª ×©×”×ª×§×‘×œ×•`);
                    } else if (progressStep <= 60) {
                        updateProgress(progressStep, '××§×‘×¥ ×”×•×“×¢×•×ª ×œ×¤×™ ×¦\'××˜×™×...', `××–×”×” ×©×™×—×•×ª ×©×œ× × ×¢× ×•`);
                    } else if (progressStep <= 80) {
                        updateProgress(progressStep, '×©×•×œ×— ×œ-Analisis AI...', `×× ×ª×— ×“×—×™×¤×•×ª ×”×©×™×—×•×ª`);
                    } else if (progressStep <= 95) {
                        updateProgress(progressStep, '××›×™×Ÿ ×“×•×—...', `××¡×“×¨ ×ª×•×¦××•×ª ×œ×¤×™ ×“×—×™×¤×•×ª`);
                    } else {
                        updateProgress(progressStep, '×©×•×œ×— ×“×•×— ×œ×•×•×¦××¤...', `×××ª×™×Ÿ ×œ××™×©×•×¨ ×©×œ×™×—×”`);
                    }
                }, 200);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        minutes: 1440
                    })
                });
                
                const result = await response.json();
                
                // Clear progress interval
                clearInterval(progressInterval);
                
                if (result.success) {
                    updateProgress(100, 'âœ… × ×™×ª×•×— ×”×¡×ª×™×™× ×‘×”×¦×œ×—×”!', `× ××¦××• ${result.report?.total_conversations || 0} ×©×™×—×•×ª ×¤×ª×•×—×•×ª`);
                    
                    setTimeout(() => {
                        hideProgressModal();
                        showNotification(result.message, 'success');
                        refreshStatus();
                    }, 2000);
                } else {
                    clearInterval(progressInterval);
                    updateProgress(100, 'âŒ ×©×’×™××” ×‘× ×™×ª×•×—', result.message);
                    
                    setTimeout(() => {
                        hideProgressModal();
                        showNotification(result.message, 'error');
                    }, 3000);
                }
            } catch (error) {
                clearInterval(progressInterval);
                updateProgress(100, 'âŒ ×©×’×™××ª ×¨×©×ª', '××™×¨×¢×” ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª');
                
                setTimeout(() => {
                    hideProgressModal();
                    showNotification('×©×’×™××” ×‘× ×™×ª×•×— ×”×•×“×¢×•×ª: ' + error.message, 'error');
                }, 3000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ” × ×ª×— ×”×•×“×¢×•×ª';
            }
        }
        
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const result = await response.json();
                
                if (result.success && result.bot_stats) {
                    document.getElementById('totalMessages').textContent = result.bot_stats.total_messages || 0;
                    document.getElementById('unansweredConversations').textContent = result.bot_stats.unanswered_conversations || 0;
                    document.getElementById('urgentConversations').textContent = result.bot_stats.urgent_conversations || 0;
                    document.getElementById('activeChats').textContent = result.bot_stats.active_chats || 0;
                    
                    // Apply global filter after refresh
                    const globalFilter = document.getElementById('globalExcludeGroups');
                    if (globalFilter && globalFilter.checked) {
                        setTimeout(() => toggleGlobalGroupFilter(), 100);
                    }
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }
        
        function showSendMessageModal() {
            const chatId = prompt('××–×”×” ×¦\'××˜ (×œ×“×•×’××”: 1234567890@c.us):');
            if (!chatId) return;
            
            const message = prompt('×ª×•×›×Ÿ ×”×”×•×“×¢×”:');
            if (!message) return;
            
            sendCustomMessage(chatId, message);
        }
        
        async function sendCustomMessage(chatId, message) {
            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'success');
                } else {
                    showNotification('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”: ' + error.message, 'error');
            }
        }
        
        async function showDatabaseStats() {
            try {
                const response = await fetch('/api/database-stats');
                const result = await response.json();
                
                if (result.success) {
                    console.log('Database Stats:', result.stats);
                    showNotification('×¡×˜×˜×™×¡×˜×™×§×•×ª ××¡×“ ×”× ×ª×•× ×™× ×–××™× ×•×ª ×‘×§×•× ×¡×•×œ', 'success');
                } else {
                    showNotification('×©×’×™××” ×‘×§×‘×œ×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('×©×’×™××” ×‘×§×‘×œ×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª: ' + error.message, 'error');
            }
        }
        
        function showConfigModal() {
            document.getElementById('configModal').style.display = 'block';
        }
        
        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }
        
        function showFetchMessagesModal() {
            document.getElementById('fetchMessagesModal').style.display = 'block';
        }
        
        function closeFetchMessagesModal() {
            document.getElementById('fetchMessagesModal').style.display = 'none';
        }
        
        function fetchRecentMessages() {
            showFetchMessagesModal();
        }
        
        function toggleGlobalGroupFilter() {
            const isChecked = document.getElementById('globalExcludeGroups').checked;
            const messagesList = document.getElementById('messagesList');
            const messageItems = messagesList.querySelectorAll('.message-item');
            
            messageItems.forEach(item => {
                const messageContent = item.querySelector('.message-content');
                const strongElement = messageContent.querySelector('strong');
                const senderText = strongElement.textContent;
                
                if (isChecked && senderText.includes('ğŸ›ï¸ (×§×‘×•×¦×”)')) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            });
            
            // Update the fetch modal checkbox to match global setting
            const modalCheckbox = document.getElementById('excludeGroups');
            if (modalCheckbox) {
                modalCheckbox.checked = isChecked;
            }
            
            const filterText = isChecked ? '×”×•×“×¢×•×ª ×§×‘×•×¦×” ××•×¡×ª×¨×•×ª' : '×”×•×“×¢×•×ª ×§×‘×•×¦×” ××•×¦×’×•×ª';
            showNotification(`ğŸ›ï¸ ${filterText}`, 'success');
        }
        
        // Handle custom minutes option
        document.addEventListener('DOMContentLoaded', function() {
            const minutesSelect = document.getElementById('messageMinutes');
            const customGroup = document.getElementById('customMinutesGroup');
            
            if (minutesSelect) {
                minutesSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customGroup.style.display = 'block';
                    } else {
                        customGroup.style.display = 'none';
                    }
                });
            }
            
            // Initialize global group filter
            const globalFilter = document.getElementById('globalExcludeGroups');
            const modalCheckbox = document.getElementById('excludeGroups');
            if (globalFilter && modalCheckbox) {
                modalCheckbox.checked = globalFilter.checked;
            }
        });
        
        async function executeFetchMessages() {
            const minutesSelect = document.getElementById('messageMinutes');
            const customMinutes = document.getElementById('customMinutes');
            const useDatabase = document.getElementById('useDatabase').checked;
            const excludeGroups = document.getElementById('excludeGroups').checked;
            
            let minutes = parseInt(minutesSelect.value);
            if (minutesSelect.value === 'custom') {
                minutes = parseInt(customMinutes.value);
                if (!minutes || minutes < 1 || minutes > 10080) {
                    showNotification('×× × ×”×›× ×¡ ××¡×¤×¨ ×“×§×•×ª ×ª×§×™×Ÿ ×‘×™×Ÿ 1 ×œ-10080', 'error');
                    return;
                }
            }
            
            closeFetchMessagesModal();
            
            try {
                // If NOT using database, call the special refresh endpoint first
                if (!useDatabase) {
                    showNotification('âš ï¸ ××©×™×›×ª ×”×•×“×¢×•×ª ×-Green API... (×–×” ×™×›×•×œ ×œ×§×—×ª ×–××Ÿ)', 'info');
                    const refreshResponse = await fetch(`/api/refresh-from-green?minutes=${minutes}`, {
                        method: 'POST'
                    });
                    const refreshResult = await refreshResponse.json();
                    if (!refreshResult.success) {
                        throw new Error('Failed to refresh from Green API');
                    }
                }
                
                // Now get messages from database
                const response = await fetch(`/api/messages?minutes=${minutes}&use_database=true&exclude_groups=${excludeGroups}`);
                const result = await response.json();
                
                if (result.success) {
                    // Update messages list
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = '';
                    
                    if (result.messages.length === 0) {
                        const filterText = excludeGroups ? ' (×œ××—×¨ ×¡×™× ×•×Ÿ ×§×‘×•×¦×•×ª)' : '';
                        messagesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘×˜×•×•×— ×”×–××Ÿ ×”××‘×•×§×©' + filterText + '</div>';
                    } else {
                        result.messages.slice(0, 20).forEach(message => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message-item';
                            
                            // Check if it's a group message and add indicator
                            const isGroup = message.chat_id && message.chat_id.includes('@g.us');
                            const groupIndicator = isGroup ? ' ğŸ›ï¸ (×§×‘×•×¦×”)' : ' ğŸ‘¤ (×¤×¨×˜×™×ª)';
                            
                            // Hide group messages if global filter is active
                            const globalFilter = document.getElementById('globalExcludeGroups');
                            const shouldHide = globalFilter && globalFilter.checked && isGroup;
                            
                            messageDiv.style.display = shouldHide ? 'none' : 'flex';
                            
                            messageDiv.innerHTML = `
                                <div class="message-content">
                                    <strong>${message.sender_name || message.sender_contact_name || '×œ× ×™×“×•×¢'}${groupIndicator}</strong>
                                    <p>${message.text_message || '(×”×•×“×¢×ª ××“×™×”)'}</p>
                                    <div class="message-meta">
                                        ${message.chat_id} â€¢ 
                                        ${new Date(message.timestamp * 1000).toLocaleString('he-IL')}
                                    </div>
                                </div>
                            `;
                            messagesList.appendChild(messageDiv);
                        });
                    }
                    
                    const filterText = excludeGroups ? ' (×œ××—×¨ ×¡×™× ×•×Ÿ ×§×‘×•×¦×•×ª)' : '';
                    showNotification(`× ××©×›×• ${result.messages.length} ×”×•×“×¢×•×ª ××”-${minutes} ×”×“×§×•×ª ×”××—×¨×•× ×•×ª${filterText}`, 'success');
                } else {
                    showNotification('×©×’×™××” ×‘××©×™×›×ª ×”×•×“×¢×•×ª: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('×©×’×™××” ×‘××©×™×›×ª ×”×•×“×¢×•×ª: ' + error.message, 'error');
            }
        }
        
        async function saveConfig() {
            const config = {
                green_api_url: document.getElementById('greenApiUrl').value,
                green_api_id_instance: document.getElementById('greenApiId').value,
                green_api_token_instance: document.getElementById('greenApiToken').value,
                user_phone_number: document.getElementById('userPhoneNumber').value,
                openrouter_api_key: document.getElementById('openrouterKey').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
                    closeConfigModal();
                    // Refresh the page to load new settings
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ' + error.message, 'error');
            }
        }
        
        async function showUrgentConversations() {
            try {
                // Fetch urgent conversations from the latest analysis
                const response = await fetch('/api/urgent-conversations');
                const result = await response.json();
                
                if (result.success && result.conversations && result.conversations.length > 0) {
                    const listDiv = document.getElementById('urgentConversationsList');
                    listDiv.innerHTML = '';
                    
                    for (const conv of result.conversations) {
                        const convDiv = document.createElement('div');
                        convDiv.style.cssText = 'background: #fff3cd; border-right: 4px solid #ff6b6b; padding: 20px; margin-bottom: 20px; border-radius: 8px;';
                        
                        // Extract phone number from chat_id
                        const phone = conv.chat_id.replace('@c.us', '').replace('@g.us', '');
                        const isGroup = conv.chat_id.includes('@g.us');
                        const waLink = isGroup ? '#' : `https://wa.me/${phone}`;
                        
                        let html = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #333;">ğŸ‘¤ ${conv.chat_name || '×œ× ×™×“×•×¢'}</h3>
                                ${!isGroup ? `<a href="${waLink}" target="_blank" style="background: #25D366; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold;">ğŸ’¬ ×¤×ª×— ×‘×•×•×¦××¤</a>` : '<span style="color: #666;">×§×‘×•×¦×”</span>'}
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <strong>ğŸ“Œ ×¡×™×‘×ª ×”×“×—×™×¤×•×ª:</strong>
                                <p style="margin: 5px 0 0 0; color: #666;">${conv.reason || '×œ× ×¦×•×™×Ÿ'}</p>
                            </div>
                        `;
                        
                        // Add last 4 messages if available
                        if (conv.messages && conv.messages.length > 0) {
                            html += '<div style="background: white; padding: 15px; border-radius: 5px; margin-top: 10px;"><strong>ğŸ’¬ 4 ×”×•×“×¢×•×ª ××—×¨×•× ×•×ª:</strong>';
                            const lastMessages = conv.messages.slice(-4);
                            
                            for (const msg of lastMessages) {
                                const msgTime = new Date(msg.timestamp * 1000).toLocaleString('he-IL');
                                const senderName = msg.sender_name || msg.sender_contact_name || '×œ× ×™×“×•×¢';
                                html += `
                                    <div style="border-right: 3px solid #667eea; padding: 10px; margin: 10px 0; background: #f8f9fa; border-radius: 5px;">
                                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">
                                            <strong>${senderName}</strong> â€¢ ${msgTime}
                                        </div>
                                        <div style="color: #333;">${msg.text_message || '(×”×•×“×¢×ª ××“×™×”)'}</div>
                                    </div>
                                `;
                            }
                            html += '</div>';
                        }
                        
                        convDiv.innerHTML = html;
                        listDiv.appendChild(convDiv);
                    }
                    
                    document.getElementById('urgentConversationsModal').style.display = 'block';
                } else {
                    showNotification('×œ× × ××¦××• ×©×™×—×•×ª ×“×—×•×¤×•×ª', 'info');
                }
            } catch (error) {
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×©×™×—×•×ª ×“×—×•×¤×•×ª: ' + error.message, 'error');
            }
        }
        
        function closeUrgentConversationsModal() {
            document.getElementById('urgentConversationsModal').style.display = 'none';
        }
        
        // Auto-refresh every 5 minutes
        setInterval(refreshStatus, 300000);
    </script>
</body>
</html>
